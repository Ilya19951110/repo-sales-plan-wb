import requests
import pandas as pd
from scripts.google_sh import save_in_gsh, get_api_in_master_table


def get_supplier_stocks(api, date, name):
    url = "https://statistics-api.wildberries.ru/api/v1/supplier/stocks"

    headers = {"Authorization": api}

    params = {
        "dateFrom": date
    }

    data_stocks = pd.DataFrame()
    try:
        print(f"üöÄüöÄ  –ù–∞—á–∏–Ω–∞—é –∑–∞–ø—Ä–æ—Å –û–°–¢–ê–¢–ö–û–í –∫ {name} ")

        res = requests.get(url, params=params, headers=headers)

        if res.status_code != 200:
            raise ValueError(f"‚ö†Ô∏è ‚ö†Ô∏è   –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ '–û–°–¢–ê–¢–ö–û–í' {res.text()}")

        stocks = res.json()

        if not stocks:
            print(f"‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API, –∫–∞–±–∏–Ω–µ—Ç {name}\n{url}")

        data_stocks = pd.DataFrame(stocks)

        data_stocks = data_stocks.rename(columns={
            'lastChangeDate': '–î–∞—Ç–∞–û–±–Ω–æ–≤–ª–µ–Ω–∏—è',
            'warehouseName': '–ù–∞–∑–≤–∞–Ω–∏–µ–°–∫–ª–∞–¥–∞',
            'nmId': '–ê—Ä—Ç–∏–∫—É–ª WB',
            'barcode': '–±–∞—Ä–∫–æ–¥',
            'quantity': '–û—Å—Ç–∞—Ç–∫–∏',
            'inWayToClient': '–í–ø—É—Ç–∏–ö–ª–∏–µ–Ω—Ç—É',
            'inWayFromClient': '–í–ø—É—Ç–∏–û—Ç–ö–ª–∏–µ–Ω—Ç–∞',
            'quantityFull': '–í—Å–µ–≥–æ–û—Å—Ç–∞—Ç–∫–æ–≤',
            'category': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
            'subject': '–ü—Ä–µ–¥–º–µ—Ç',
            'brand': '–ë—Ä–µ–Ω–¥',
            'techSize': '–†–∞–∑–º–µ—Ä',
            'Price': '–¶–µ–Ω–∞',
            'Discount': '–°–∫–∏–¥–∫–∞',
            'isSupply': '–î–æ–≥–æ–≤–æ—Ä–ü–æ—Å—Ç–∞–≤–∫–∏',
            'isRealization': '–¥–æ–≥–æ–≤–æ–†–µ–∞–ª–∏–∑–∞—Ü–∏–∏',
            'SCCode': '–ö–æ–¥–ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞',
            'supplierArticle': '–ê—Ä—Ç–∏–∫—É–ª–ü—Ä–æ–¥–∞–≤—Ü–∞'
        })
        data_stocks['–î–∞—Ç–∞–û–±–Ω–æ–≤–ª–µ–Ω–∏—è'] = pd.to_datetime(
            data_stocks['–î–∞—Ç–∞–û–±–Ω–æ–≤–ª–µ–Ω–∏—è']).dt.date

        data_stocks['–†–∞–∑–º–µ—Ä'] = data_stocks['–†–∞–∑–º–µ—Ä'].astype(str)

    except Exception as e:
        print(f"‚ùå‚ùå  –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–∞ {name} –ø—Ä–∏ –≤—ã–∑–æ–≤–µ: {e}")
    return data_stocks


if __name__ == '__main__':
    cabinet = {}

    for name, (api, date) in get_api_in_master_table().items():
        cabinet[name] = get_supplier_stocks(name=name, api=api, date=date)

    # promo_count(api=api)
    save_in_gsh(cabinet=cabinet, sheet_name='–û—Å—Ç–∞—Ç–∫–∏ (api)')
